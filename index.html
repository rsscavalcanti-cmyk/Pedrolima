<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Lousa App ‚Äî Rotina do Pedro</title>
  <meta name="description" content="Lousa interativa infantil ‚Äî rotina di√°ria com salvamento no celular, √≠cones grandes e relat√≥rio simples em texto." />
  <meta name="theme-color" content="#7cc5ff" />
  <meta name="mobile-web-app-capable" content="yes">
  <style>
    :root{
      --bg:#f9fbff; --paper:#ffffff; --ink:#0f172a; --muted:#667085; --line:#e7eef8;
      --brand:#38bdf8; --brand2:#7cc5ff; --ok:#22c55e; --warn:#f59e0b; --radius:22px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:'Nunito',system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    h1,h2{margin:0}
    .app{max-width:880px;margin:0 auto;padding:16px 14px calc(28px + env(safe-area-inset-bottom))}
    header{display:grid;grid-template-columns:auto 1fr auto;gap:12px;align-items:center;margin-bottom:12px}
    .avatar{width:80px;height:80px;border-radius:24px;background:var(--paper);border:2px solid var(--line);display:grid;place-items:center;overflow:hidden;box-shadow:0 8px 22px rgba(0,0,0,.05)}
    .avatar img{width:100%;height:100%;object-fit:cover}
    .title h1{font-size:clamp(22px,5.5vw,32px)}
    .title p{margin-top:4px;color:var(--muted);font-size:14px}
    .topBtns{display:flex;gap:8px;flex-wrap:wrap}
    .btn{appearance:none;border:2px solid var(--line);background:var(--paper);border-radius:999px;padding:10px 14px;font-weight:800;color:#0f172a;box-shadow:0 6px 18px rgba(0,0,0,.06);cursor:pointer}
    .btn:active{transform:translateY(1px)}

    .card{background:var(--paper);border:2px solid var(--line);border-radius:var(--radius);padding:12px 12px 14px;box-shadow:0 18px 40px rgba(0,0,0,.06)}

    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
    .tab{padding:8px 14px;border-radius:999px;border:2px solid var(--line);background:#f3f8ff;color:#173b6b;font-weight:900;cursor:pointer}
    .tab.active{background:linear-gradient(180deg,var(--brand2),var(--brand));color:#05355d;border-color:transparent;box-shadow:0 8px 22px rgba(56,189,248,.35)}

    .timeline{display:grid;gap:10px}
    .row{display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center;padding:10px;border-radius:18px;border:2px solid var(--line);background:linear-gradient(180deg,#fff,#f7fbff)}
    .time{font-variant-numeric:tabular-nums;font-weight:900;color:#0b3f70}
    .label{font-size:16px}
    .emoji{font-size:22px;margin-right:6px}
    .chip{font-size:12px;font-weight:800;padding:4px 8px;border-radius:999px;background:#eef6ff;border:2px solid var(--line);color:#174e86}

    .check{width:32px;height:32px;border-radius:10px;border:3px solid #9acbff;background:#fff;display:grid;place-items:center;cursor:pointer}
    .check.done{background:var(--ok);border-color:var(--ok);color:#fff}
    .when{font-size:12px;color:#20734a;font-weight:800}

    .grid{display:grid;grid-template-columns:1fr;gap:14px}
    @media(min-width:860px){.grid{grid-template-columns:1.2fr .8fr}}

    .note{font-size:13px;color:var(--muted)}
    .rule{display:flex;gap:10px;align-items:center;padding:10px;border:2px dashed #cfe4ff;border-radius:16px;background:#f2f8ff}
    .rule strong{color:#0856a7}

    .report{display:grid;gap:8px}
    textarea{width:100%;min-height:140px;padding:12px;border-radius:16px;border:2px solid var(--line);font-family:'Nunito',system-ui,sans-serif}

    footer{margin-top:20px;text-align:center;color:var(--muted);font-size:12px}

    /* Banner de instala√ß√£o (Android) */
    .install{position:fixed;inset:auto 12px 12px 12px;background:#ffffff;border:2px solid #d8e8ff;border-radius:18px;box-shadow:0 18px 40px rgba(0,0,0,.08);padding:12px;display:none;gap:10px;align-items:center;z-index:50}
    .install.show{display:flex}
    .install img{width:44px;height:44px;border-radius:12px;border:1px solid #d8e8ff}
    .install .text{flex:1}
    .install .text b{display:block}

    /* Status badge */
    .status{position:fixed;right:12px;top:12px;background:#fff;border:2px solid #d8e8ff;border-radius:999px;padding:6px 10px;font-size:12px;color:#0b3f70;box-shadow:0 10px 22px rgba(0,0,0,.06);z-index:60}
  </style>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@600;700;800;900&display=swap" rel="stylesheet">
</head>
<body>
  <div class="app">
    <header>
      <div class="avatar" id="avatarBox" title="Toque para escolher uma foto">
        <svg width="44" height="44" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <circle cx="12" cy="8" r="4" stroke="#7cc5ff" stroke-width="1.8"/>
          <path d="M4 21a8 8 0 0 1 16 0" stroke="#7cc5ff" stroke-width="1.8"/>
        </svg>
      </div>
      <div class="title">
        <h1>Rotina do <span id="nome" contenteditable="true">Pedro</span> üê£</h1>
        <p class="note">Ter/Qui ‚Äî Nata√ß√£o √†s 15:00 ‚Ä¢ Salva automaticamente no seu celular ‚Ä¢ √öltima atualiza√ß√£o: <span id="stamp"></span></p>
      </div>
      <div class="topBtns">
        <input type="file" id="avatar" accept="image/*" hidden>
        <button class="btn" id="btnInstall" style="display:none">Instalar</button>
        <button class="btn" id="btnShare">Compartilhar relat√≥rio</button>
        <button class="btn" id="btnPrint">Imprimir</button>
        <button class="btn" id="btnReset">Zerar o dia</button>
      </div>
    </header>

    <div class="grid">
      <section class="card">
        <h2>Agenda di√°ria</h2>
        <div class="tabs" id="tabs"></div>
        <div class="timeline" id="list"></div>
        <p class="note">Dica: toque no quadradinho para marcar. O hor√°rio de conclus√£o fica registrado.</p>
      </section>

      <aside class="card">
        <h2>Regras e lembretes</h2>
        <div class="rule"><span class="emoji">ü™•</span> <strong>Escovar os dentes ap√≥s todas as refei√ß√µes</strong></div>
        <div class="rule"><span class="emoji">üéí</span> <strong>Mochila pronta na noite anterior</strong></div>
        <div class="rule"><span class="emoji">üíß</span> <strong>Levar garrafinha de √°gua</strong></div>
        <br/>
        <h2>Relat√≥rio simples</h2>
        <div class="report">
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn" id="btnReportHoje">Relat√≥rio de hoje</button>
            <button class="btn" id="btnReportSemana">Relat√≥rio da semana</button>
            <button class="btn" id="btnCopy">Copiar</button>
          </div>
          <textarea id="reportBox" placeholder="Os relat√≥rios gerados aparecem aqui. Voc√™ pode copiar e enviar por WhatsApp."></textarea>
        </div>
      </aside>
    </div>

    <footer>Funciona offline ‚Ä¢ Adicione √† tela inicial para ser um app ‚ú®</footer>
  </div>

  <!-- Banner de instala√ß√£o para fallback -->
  <div class="install" id="installBanner" role="dialog" aria-live="polite">
    <img id="iIcon" alt="√çcone" />
    <div class="text">
      <b>Instalar ‚ÄúLousa do Pedro‚Äù?</b>
      <div class="note">Toque em Instalar para adicionar √† sua tela inicial.</div>
    </div>
    <button class="btn" id="iYes">Instalar</button>
    <button class="btn" id="iNo">Agora n√£o</button>
  </div>

  <div class="status" id="status">Checando instala√ß√£o‚Ä¶</div>

  <script>
    /* =============================================================
       Lousa App ‚Äî corre√ß√£o de Service Worker
       PROBLEMA: Registrar SW a partir de URL "blob:" falha.
       SOLU√á√ÉO: S√≥ registrar SW via arquivo HTTP/HTTPS real (ex.: sw.js).
       - Antes de registrar, faz-se um fetch de sw.js; s√≥ registra se existir.
       - Em contextos n√£o seguros (ex.: preview blob, file://), n√£o registra
         e mostra um aviso + fallback para "Adicionar √† tela inicial" pelo menu.
       ============================================================= */

    /* ===================== Dados base ===================== */
    const BASE = [
      {time:"06:15", label:"Caf√© da manh√£", key:"cafe", icon:"ü•£"},
      {time:"06:30", label:"Escovar dentes e banho", key:"banho", icon:"ü™•"},
      {time:"07:20", label:"Escola", key:"escola", icon:"üè´"},
      {time:"12:30", label:"Almo√ßo ‚Üí escovar dentes", key:"almoco", icon:"üçΩÔ∏è"},
      {time:"14:30", label:"Estudos + Ingl√™s em casa", key:"estudos", icon:"üìö"},
      {time:"15:00", label:"Varrer o quintal", key:"quintal", icon:"üßπ", alt:{days:[2,4], label:"Nata√ß√£o üèä‚Äç‚ôÇÔ∏è"}},
      {time:"Livre", label:"Tempo livre (ap√≥s as tarefas)", key:"livre", icon:"üß©"},
      {time:"18:30", label:"Jantar ‚Üí escovar dentes", key:"jantar", icon:"üçΩÔ∏è"},
      {time:"21:00", label:"Lanche da noite", key:"lancheNoite", icon:"ü•õ"},
      {time:"21:15", label:"Dormir", key:"dormir", icon:"üåô"},
    ];
    const DIAS=["Seg","Ter","Qua","Qui","Sex","S√°b","Dom"]; // 0..6

    /* ===================== Estado / Storage ===================== */
    const KEY='lousa-app-pedro-v4'; // bump para isolar do cache anterior
    const NAMEKEY='lousa-app-nome';
    const IMGKEY='lousa-app-avatar';

    const now=()=>new Date();
    const pad=n=>String(n).padStart(2,'0');
    const fmt=(d)=>`${pad(d.getHours())}:${pad(d.getMinutes())}`;
    const fmtFull=(d)=>`${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${fmt(d)}`;

    const load=()=>JSON.parse(localStorage.getItem(KEY)||'{}');
    const save=(obj)=>localStorage.setItem(KEY,JSON.stringify(obj));

    let dayIndex=((new Date().getDay()+6)%7); // seg=0
    const dayKey=(i=dayIndex)=>`d${i}`;
    function getDay(i=dayIndex){ const db=load(); return db[dayKey(i)]||{} }
    function setDay(data,i=dayIndex){ const db=load(); db[dayKey(i)]=data; save(db); stamp.textContent=fmtFull(now()) }

    /* ===================== UI ===================== */
    const tabs=document.getElementById('tabs');
    const list=document.getElementById('list');
    const stamp=document.getElementById('stamp');
    const reportBox=document.getElementById('reportBox');
    const statusEl=document.getElementById('status');

    function renderTabs(){
      tabs.innerHTML='';
      DIAS.forEach((d,i)=>{
        const b=document.createElement('button');
        b.className='tab'+(i===dayIndex?' active':'');
        b.textContent=d; b.onclick=()=>{dayIndex=i; renderTabs(); renderList();};
        tabs.appendChild(b);
      });
    }

    function renderList(){
      list.innerHTML='';
      const day=getDay();
      BASE.forEach(item=>{
        let label=item.label; if(item.alt && item.alt.days.includes(dayIndex)) label=item.alt.label;
        const row=document.createElement('div'); row.className='row';
        const ck=document.createElement('div');
        ck.className='check'+(day[item.key]?.done?' done':'');
        ck.title=day[item.key]?.done?`Conclu√≠do √†s ${day[item.key]?.time}`:'Marcar como conclu√≠do';
        ck.onclick=()=>{ const cur=getDay(); const was=!!cur[item.key]?.done; cur[item.key]={done:!was, time:fmt(now())}; setDay(cur); renderList(); };
        const time=document.createElement('div'); time.className='time'; time.textContent=item.time;
        const labelBox=document.createElement('div'); labelBox.className='label'; labelBox.innerHTML=`<span class="emoji">${item.icon}</span>${label}`;
        const right=document.createElement('div');
        const when=document.createElement('div'); when.className='when'; if(day[item.key]?.done){ when.textContent=`‚úì ${day[item.key].time}` }
        const chip=document.createElement('div'); chip.className='chip'; chip.textContent='Di√°rio';
        right.appendChild(when); right.appendChild(chip);
        row.appendChild(ck); row.appendChild(time); row.appendChild(labelBox); row.appendChild(right);
        list.appendChild(row);
      });
    }

    /* ===================== Relat√≥rios ===================== */
    function relatorioDia(i){
      const data=getDay(i); const nome=document.getElementById('nome').textContent.trim()||'Pedro';
      const hoje=new Date(); const titulo=`Relat√≥rio ‚Äî ${DIAS[i]} (${pad(hoje.getDate())}/${pad(hoje.getMonth()+1)}/${hoje.getFullYear()}) ‚Äî ${nome}`;
      const linhas=BASE.map(it=>{ let lbl=it.label; if(it.alt&&it.alt.days.includes(i)) lbl=it.alt.label; const st=data[it.key]; const mark=st?.done?'[OK]':'[ ]'; const at=st?.time?` ‚Äî ${st.time}`:''; return `${mark} ${it.time} ‚Äî ${lbl}${at}`; });
      return `${titulo}\n${'-'.repeat(titulo.length)}\n`+linhas.join('\n');
    }
    function relatorioSemana(){ let out=[]; const nome=document.getElementById('nome').textContent.trim()||'Pedro'; out.push(`Relat√≥rio semanal ‚Äî ${nome}`); out.push('=============================='); for(let i=0;i<7;i++){ out.push(`\n${DIAS[i]}:`); out.push(relatorioDia(i)); } return out.join('\n'); }

    document.getElementById('btnReportHoje').onclick=()=>{ reportBox.value=relatorioDia(dayIndex) };
    document.getElementById('btnReportSemana').onclick=()=>{ reportBox.value=relatorioSemana() };
    document.getElementById('btnCopy').onclick=()=>{ reportBox.select(); document.execCommand('copy') };
    document.getElementById('btnPrint').onclick=()=>window.print();
    document.getElementById('btnReset').onclick=()=>{ const db=load(); db[dayKey()]= {}; save(db); renderList(); };

    document.getElementById('btnShare').onclick=async()=>{ const text=relatorioDia(dayIndex); if(navigator.share){ try{ await navigator.share({text}); }catch(e){} } else { reportBox.value=text; alert('Relat√≥rio gerado. Copie no campo abaixo.'); } };

    /* ===================== Nome & Foto ===================== */
    const nomeEl=document.getElementById('nome');
    nomeEl.addEventListener('input',()=> localStorage.setItem(NAMEKEY, nomeEl.textContent.trim()||'Pedro'));
    const n=localStorage.getItem(NAMEKEY); if(n) nomeEl.textContent=n;
    const avatarInput=document.getElementById('avatar');
    const avatarBox=document.getElementById('avatarBox');
    function setAvatar(src){ avatarBox.innerHTML=`<img alt="Foto do ${nomeEl.textContent}" src="${src}">` }
    avatarBox.addEventListener('click', ()=> avatarInput.click());
    avatarInput.addEventListener('change', e=>{ const f=e.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ localStorage.setItem(IMGKEY, r.result); setAvatar(r.result) }; r.readAsDataURL(f) });
    const storedImg=localStorage.getItem(IMGKEY); if(storedImg) setAvatar(storedImg);

    /* ===================== Manifest din√¢mico (ok em HTTPS) ===================== */
    const PNG192 = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAADAAQAAAAA6f6VAAABlElEQVR4nO3TwQmDQBRA0Xbq4FQW7iY0Kqg7qgU2WmQy0s0r7h1r3g0c8j8G4i8hU2w6Cj0F6Kq8m9m1x4j3zO1fXG3v1y8r7gF0F3g5F8Y0A1n6k4gG2gA0k2Ew6y7f0h2c8y2QG3y6D9m2u8L9qJw0iC3xwqv0m1r8H3oX1w1b4m5o0qf7HqgGxwqKxwqKxwqKxwqKxwqKxwqKxwqKxwqKxwqKxwqKx4K9vYb2VwqKxwqKxwqKxwqKxwqKxwqKxwqKxwqKxwqKxwqKx8C8z4H9b0y+9J5g3z0S0v3z1Gf9Yc0v3z1Gf9Yc0v3z1Gf9Yc0v3z1Gf9Yc4K9j7v3e+0w8nry1Sx0AAAAASUVORK5CYII=';
    const PNG512 = PNG192; // placeholder; para produ√ß√£o, use PNGs reais

    const manifest = {
      name: "Lousa App ‚Äî Rotina do Pedro",
      short_name: "Lousa do Pedro",
      description: "Rotina infantil com check de tarefas, salvamento local e relat√≥rio.",
      display: "standalone",
      display_override: ["standalone","minimal-ui"],
      start_url: ".?source=pwa",
      scope: ".",
      background_color: "#f9fbff",
      theme_color: "#7cc5ff",
      icons: [
        { src: PNG192, sizes: "192x192", type: "image/png", purpose: "any" },
        { src: PNG512, sizes: "512x512", type: "image/png", purpose: "any" }
      ]
    };
    const manBlob = new Blob([JSON.stringify(manifest)], { type: 'application/manifest+json' });
    const manUrl = URL.createObjectURL(manBlob);
    const link = document.createElement('link'); link.rel='manifest'; link.href=manUrl; document.head.appendChild(link);

    /* ===================== Service Worker (sem blob:) ===================== */
    const btnInstall=document.getElementById('btnInstall');
    const installBanner=document.getElementById('installBanner');
    const iYes=document.getElementById('iYes'); const iNo=document.getElementById('iNo');

    const isSecure = window.isSecureContext && /^(https:)|(^http:\/\/localhost)/.test(location.href);
    const swUrl = (()=>{ // sw.js ao lado do index.html
      const base = location.pathname.replace(/\/[^\/]*$/, '/');
      return base + 'sw.js';
    })();

    function setStatus(msg){ statusEl.textContent = msg; }

    async function maybeRegisterSW(){
      if(!('serviceWorker' in navigator)) { setStatus('Navegador sem suporte a Service Worker'); return; }
      if(!isSecure){
        setStatus('Visualiza√ß√£o (sem SW). Para instalar, publique via HTTPS.');
        return; // evita tentativa em blob:/file:
      }
      try{
        // Verifica se sw.js existe no servidor (evita erro de 404 ou blob:)
        const res = await fetch(swUrl, {cache:'no-store'});
        if(!res.ok){ setStatus('sw.js n√£o encontrado ‚Äî publique o arquivo junto do index.html'); return; }
        const ct = (res.headers.get('content-type')||'').toLowerCase();
        if(!ct.includes('javascript') && !ct.includes('text')){ setStatus('sw.js inv√°lido ‚Äî verifique o conte√∫do JS'); return; }
        await navigator.serviceWorker.register(swUrl);
        setStatus('Offline pronto ‚úÖ');
      }catch(err){
        console.warn('Falha ao registrar SW:', err);
        setStatus('Falha ao registrar SW ‚Äî veja o console');
      }
    }

    // A2HS (Add to Home Screen)
    let deferredPrompt=null;
    window.addEventListener('beforeinstallprompt', (e)=>{
      e.preventDefault(); deferredPrompt=e; btnInstall.style.display='inline-block'; installBanner.classList.add('show');
      try{ document.getElementById('iIcon').src = PNG192; }catch(_){ }
    });
    async function triggerInstall(){
      if(!deferredPrompt){ alert('Se o bot√£o n√£o aparecer, use o menu do Chrome: ‚ÄúAdicionar √† tela inicial‚Äù.'); return; }
      deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null; btnInstall.style.display='none'; installBanner.classList.remove('show');
    }
    btnInstall.addEventListener('click', triggerInstall);
    iYes.addEventListener('click', triggerInstall);
    iNo.addEventListener('click', ()=> installBanner.classList.remove('show'));

    /* ===================== Testes (sanity checks) ===================== */
    function eligible(url, secure){ return secure && /^(https:)|(^http:\/\/localhost)/.test(url) }
    ;(function runTests(){
      const tests = [
        {name:'HTTPS eleg√≠vel', got: eligible('https://site', true), exp:true},
        {name:'localhost eleg√≠vel', got: eligible('http://localhost:8080', true), exp:true},
        {name:'blob N√ÉO eleg√≠vel', got: eligible('blob:https://site', true), exp:false},
        {name:'file N√ÉO eleg√≠vel', got: eligible('file:///index.html', true), exp:false},
        {name:'http sem secureContext N√ÉO eleg√≠vel', got: eligible('http://site', false), exp:false},
      ];
      tests.forEach(t=> console.assert(t.got===t.exp, `Teste falhou: ${t.name}`));
      console.log('Testes SW:', tests);
    })();

    /* ===================== Boot ===================== */
    function render(){ renderTabs(); renderList(); stamp.textContent=fmtFull(new Date()); }
    render();
    maybeRegisterSW();
  </script>
</body>
</html>

